name: payplug
recipe: wordpress
config:
  webroot: wordpress
  php: '7.0'
services:
  chromedriver:
    type: compose
    services:
      image: robcherry/docker-chromedriver:latest
      expose:
      - "4444"
      environment:
        CHROMEDRIVER_WHITELISTED_IPS: ""
        CHROMEDRIVER_URL_BASE: "/wd/hub"
        CHROMEDRIVER_EXTRA_ARGS: "--ignore-certificate-errors --reduce-security-for-testing --enable-features=NetworkService"
      security_opt:
      - seccomp:unconfined
      command: ["/usr/local/bin/supervisord", "-c", "/etc/supervisord.conf"]

  appserver:
    run_as_root:
    - "cd /usr/local/bin && wget https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip && unzip -o BrowserStackLocal-linux-x64.zip && chmod +x BrowserStackLocal && rm BrowserStackLocal-linux-x64.zip"
    - "mysql -u root -h database -e 'CREATE DATABASE IF NOT EXISTS wpTests;'"
    - "mysql -u root -h database -e 'GRANT ALL PRIVILEGES ON *.* TO 'wordpress';'"
    - "mysql -u root -h database -e 'FLUSH PRIVILEGES;'"
tooling:
  # Browserstack for local/travis
  launch-browserstack:
    service: appserver
    cmd: ./bin/lando-browserstack.sh
  # Test commands
  test:
    service: appserver
    cmd: composer test
    description: Run all tests, acceptance and unit
  test-wpunit:
    service: appserver
    cmd: composer test-wpunit
    description: Run our wpunit tests
  test-acceptance:
    service: appserver
    cmd: composer test-acceptance
    description: Run our acceptance tests
  test-acceptance-browserstack:
    service: appserver
    cmd: composer test-acceptance-browserstack
    description: Run our acceptance tests on browserstack

events:
  # Run some commands after `lando start`
  post-start:
  - cd $LANDO_MOUNT && composer install
